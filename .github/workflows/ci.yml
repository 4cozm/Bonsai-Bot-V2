name: CI

# PR이 열린 상태(머지 대기)에서만 실행. dev에 직접 push/머지 시에는 실행하지 않음.
on:
    pull_request:
        branches: ["dev"]

jobs:
    test-and-coverage:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - run: npm ci

            - name: Prettier check
              run: npm run format:check

            - name: ESLint
              run: npm run lint

            - name: Test + Coverage
              run: npm run test:cov

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage/lcov.info
                  fail_ci_if_error: true
                  verbose: true

            - name: Build Codecov PR URL
              if: ${{ github.event_name == 'pull_request' }}
              id: codecov_url
              run: |
                  echo "url=https://app.codecov.io/gh/${{ github.repository }}/pull/${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

            - name: Notify Discord (PR만)
              if: ${{ always() && github.event_name == 'pull_request' }}
              env:
                  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
                  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                  CODECOV_URL: ${{ steps.codecov_url.outputs.url }}
                  REPO: ${{ github.repository }}
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
              run: |
                  if [ -z "$DISCORD_WEBHOOK_URL" ]; then
                    echo "DISCORD_WEBHOOK_URL 없음 - 알림 스킵"
                    exit 0
                  fi

                  if [ "${{ job.status }}" = "success" ]; then
                    STATUS_TEXT="✅ CI 통과 (PR #${PR_NUMBER})"
                    COLOR=3066993
                  else
                    STATUS_TEXT="❌ CI 실패 (PR #${PR_NUMBER})"
                    COLOR=15158332
                  fi

                  # (옵션) Codecov 배지 이미지 (브랜치 기준). dev가 기본이면 그대로 사용.
                  BADGE_URL="https://codecov.io/gh/${REPO}/branch/dev/graph/badge.svg"

                  # embed json
                  payload=$(cat <<JSON
                  {
                    "username": "Bonsai-Bot",
                    "embeds": [
                      {
                        "title": "${STATUS_TEXT}",
                        "description": "${PR_TITLE}",
                        "color": ${COLOR},
                        "fields": [
                          { "name": "Run", "value": "${RUN_URL}", "inline": false }
                          $(if [ "${{ job.status }}" = "success" ]; then echo ",{ \"name\": \"Codecov\", \"value\": \"${CODECOV_URL}\", \"inline\": false }"; fi)
                        ],
                        "thumbnail": { "url": "${BADGE_URL}" }
                      }
                    ]
                  }
                  JSON
                  )

                  curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"
